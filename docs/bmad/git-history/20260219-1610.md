# Session 2026-02-19 après-midi — Intégration Gemini stable

Date : 2026-02-19 ~14h20 → 16h10

## Résumé

Session consacrée à la stabilisation de l'intégration Gemini dans WEGOGYM.
Plusieurs problèmes successifs ont été découverts et corrigés : compatibilité
Hermes (`AbortSignal.timeout`), messages d'erreur opaques (body JSON non lu),
recherche du bon modèle Gemini compatible EU, et affichage de hints contextuels
dans l'UI. La session s'est conclue par le refactoring de l'écran Assistant
en wizard interactif step-by-step.

**Résultat :** Gemini opérationnel avec `gemini-2.0-flash` + billing Google Cloud.

---

## Commits

| Hash | Type | Description |
|------|------|-------------|
| `cff2bd5` | fix | `SettingsScreen` : affiche le vrai message d'erreur lors du test de connexion |
| `2ffcfdd` | docs | Rapport bmad fix settings erreur connexion AI |
| `16b393e` | feat | `geminiProvider` : lecture body erreur JSON + robustesse test connexion |
| `8650ffc` | docs | Rapport bmad fix gemini connexion provider |
| `b418839` | fix | `geminiProvider` : remplace `AbortSignal.timeout` par `AbortController` (Hermes) |
| `1c027db` | fix | `geminiProvider` : mise à jour modèle `gemini-1.5-flash` → `gemini-2.0-flash` |
| `8ff8ce7` | fix | `geminiProvider` : test modèle `gemini-2.0-flash-lite` (free tier EU — 429) |
| `4a8ec79` | fix | `SettingsScreen` : ajout hint 429 quota Gemini |
| `0c640e1` | fix | `geminiProvider` : test modèle `gemini-2.0-flash-exp` (429 aussi) |
| `331e6ec` | fix | `SettingsScreen` : hint 429 enrichi — guide vers AI Studio |
| `af73951` | fix | `SettingsScreen` : hint 429 précisé — restriction EU free tier |
| `48202ee` | feat | `AssistantScreen` : refactoring en wizard interactif 7 étapes |
| `84cfcc3` | fix | `geminiProvider` : retour à `gemini-2.0-flash` — billing activé, flash-exp retiré |

---

## Problèmes rencontrés & solutions

### 1. `AbortSignal.timeout` — Incompatibilité Hermes
**Symptôme :** Erreur ou crash silencieux lors du timeout de requête Gemini.
**Cause :** `AbortSignal.timeout()` est une API Web moderne non implémentée dans
Hermes (moteur JS de React Native).
**Solution :** Remplacement par `AbortController` + `setTimeout` + `clearTimeout`
dans le bloc `finally`. Pattern standard compatible tous environnements.

---

### 2. Messages d'erreur opaques
**Symptôme :** L'UI affichait `"Connexion échouée"` ou `"Erreur HTTP 429"` sans
détail, rendant le diagnostic impossible pour l'utilisateur.
**Cause :** Le provider ne lisait pas le body JSON de la réponse d'erreur.
Le `SettingsScreen` n'affichait pas le message renvoyé par le provider.
**Solution :**
- `geminiProvider` : ajout de `await response.json()` pour lire `error.message`.
- `SettingsScreen` : propagation du message d'erreur réel vers l'UI.
- Hints contextuels selon le code HTTP (429 / 403).

---

### 3. Gemini free tier indisponible en EU
**Symptôme :** Toutes les requêtes avec une clé gratuite retournent HTTP 429,
quel que soit le modèle testé (`gemini-2.0-flash`, `gemini-2.0-flash-lite`,
`gemini-2.0-flash-exp`).
**Cause :** Depuis décembre 2025, le free tier Gemini n'est plus disponible
depuis l'Union Européenne. Les restrictions géographiques s'appliquent à tous
les modèles de la famille Gemini 2.0.
**Solution :** Activation du billing Google Cloud. La clé API doit appartenir
au même projet Google Cloud que celui sur lequel le billing est activé.
Modèle stabilisé sur `gemini-2.0-flash` (stable, performant).

---

### 4. Mauvaise communication des erreurs vers l'utilisateur
**Symptôme :** Même avec le billing activé, l'utilisateur ne savait pas
pourquoi la connexion échouait (quota, billing, région, clé invalide...).
**Solution :** Hints contextuels dans `SettingsScreen` :
- Code 429 → message EU free tier + lien vers Google AI Studio pour une clé billing.
- Code 403 → message API non activée dans le projet Google Cloud.

---

## État final

- **Provider actif :** Gemini (`gemini-2.0-flash`)
- **Billing requis :** Oui (Google Cloud, projet lié à la clé API)
- **Tests :** 638 passed
- **TypeScript :** 0 erreurs
- **Fichiers modifiés :**
  - `mobile/src/services/aiProviders/geminiProvider.ts`
  - `mobile/src/screens/SettingsScreen.tsx`
  - `mobile/src/screens/AssistantScreen.tsx`
