<!-- v1.0 — 2026-02-27 -->
# Rapport — timer-son — Groupe C (Settings + WorkoutScreen) — 20260227-1030

## Objectif
1. Ajouter 2 nouveaux toggles dans SettingsScreen : "Vibration fin de repos" et "Son fin de repos"
2. Modifier WorkoutScreen pour passer `vibrationEnabled` et `soundEnabled` au composant RestTimer

**Prérequis : Groupes A et B doivent être terminés avant de lancer ce groupe.**

## Fichiers concernés
- `mobile/src/screens/SettingsScreen.tsx`
- `mobile/src/screens/WorkoutScreen.tsx`

## Contexte technique

### SettingsScreen.tsx
- Fichier : `mobile/src/screens/SettingsScreen.tsx`
- Pattern des toggles existants. Exemple pour `timerEnabled` (à répliquer) :
  - State local : `const [timerEnabled, setTimerEnabled] = useState(user?.timerEnabled ?? true)`
  - useEffect sync : dans l'effet qui lit `user`, ajouter `setVibrationEnabled(user.vibrationEnabled ?? true)` et `setTimerSoundEnabled(user.timerSoundEnabled ?? true)`
  - Handler async :
    ```typescript
    const handleToggleVibration = async (enabled: boolean) => {
      if (!user) return
      setVibrationEnabled(enabled)
      try {
        await database.write(async () => {
          await user.update(u => { u.vibrationEnabled = enabled })
        })
        haptics.onPress()
      } catch {
        setVibrationEnabled(!enabled)
      }
    }
    ```
  - JSX Switch (dans la même section "Minuteur de repos") :
    ```tsx
    <Switch
      value={vibrationEnabled}
      onValueChange={handleToggleVibration}
      trackColor={{ false: colors.cardSecondary, true: colors.primary }}
      thumbColor={colors.text}
    />
    ```
- Les 2 nouveaux toggles se placent **dans la section existante du minuteur** (après le toggle "Activer le minuteur" et "Durée de repos"), sous un label "Vibration fin de repos" et "Son fin de repos"
- User model fields (du Groupe A) : `user.vibrationEnabled` (boolean) et `user.timerSoundEnabled` (boolean)
- Database pattern : toutes les mutations dans `database.write()` (CLAUDE.md Known Pitfalls)
- `database` importé de `../model/index`

### WorkoutScreen.tsx
- Fichier : `mobile/src/screens/WorkoutScreen.tsx`
- L'utilisateur (`user`) est déjà disponible via `withObservables`
- Le RestTimer est rendu conditionnellement (chercher `showRestTimer`), exemple actuel :
  ```tsx
  <RestTimer
    duration={user?.restDuration ?? 90}
    onClose={() => setShowRestTimer(false)}
    notificationEnabled={notificationPermissionRef.current}
  />
  ```
- Ajouter les 2 nouvelles props :
  ```tsx
  <RestTimer
    duration={user?.restDuration ?? 90}
    onClose={() => setShowRestTimer(false)}
    notificationEnabled={notificationPermissionRef.current}
    vibrationEnabled={user?.vibrationEnabled ?? true}
    soundEnabled={user?.timerSoundEnabled ?? true}
  />
  ```

## Étapes

### 1. SettingsScreen.tsx — 2 nouveaux state locaux
Après `const [timerEnabled, setTimerEnabled] = useState(user?.timerEnabled ?? true)` :
```typescript
const [vibrationEnabled, setVibrationEnabled] = useState(user?.vibrationEnabled ?? true)
const [timerSoundEnabled, setTimerSoundEnabled] = useState(user?.timerSoundEnabled ?? true)
```

### 2. SettingsScreen.tsx — useEffect sync
Dans l'effet qui synchronise les états depuis `user`, ajouter :
```typescript
setVibrationEnabled(user.vibrationEnabled ?? true)
setTimerSoundEnabled(user.timerSoundEnabled ?? true)
```

### 3. SettingsScreen.tsx — 2 handlers
```typescript
const handleToggleVibration = async (enabled: boolean) => { ... }
const handleToggleTimerSound = async (enabled: boolean) => { ... }
```
(Pattern identique à `handleToggleTimer`)

### 4. SettingsScreen.tsx — JSX (2 nouvelles lignes de toggle)
Dans la section "Minuteur de repos", ajouter après la durée de repos :
- Row "Vibration fin de repos" → Switch `value={vibrationEnabled}` `onValueChange={handleToggleVibration}`
- Row "Son fin de repos" → Switch `value={timerSoundEnabled}` `onValueChange={handleToggleTimerSound}`

### 5. WorkoutScreen.tsx — passer les 2 nouvelles props à RestTimer
Ajouter `vibrationEnabled` et `soundEnabled` dans le JSX RestTimer (voir ci-dessus).

## Contraintes
- Ne pas casser : les toggles existants (thème, minuteur, durée, streakTarget)
- Respecter : mutations DB dans `database.write()`, pas de `any`, `colors.*` pour les couleurs
- Valeurs par défaut : `?? true` pour les deux nouvelles props

## Critères de validation
- `npx tsc --noEmit` → zéro erreur
- `npm test` → zéro fail
- Manuel : Settings → section minuteur affiche "Vibration fin de repos" et "Son fin de repos" avec des Switch
- Manuel : toggle Son OFF → timer se termine sans son
- Manuel : toggle Vibration OFF → timer se termine sans vibration
- Manuel : les préférences sont persistées (reload de l'app → toggles dans le bon état)

## Dépendances
Ce groupe **dépend de Groupe A** (champs DB `vibrationEnabled` et `timerSoundEnabled` sur User).
Ce groupe **dépend de Groupe B** (props `vibrationEnabled` et `soundEnabled` sur RestTimer).

## Statut
✅ Résolu — 20260227-1030

## Résolution
Rapport do : docs/bmad/do/20260227-1030-feat-timer-son-C.md
