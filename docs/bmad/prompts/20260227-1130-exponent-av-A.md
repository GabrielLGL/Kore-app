<!-- v1.0 — 2026-02-27 -->
# Rapport — exponent-av — Groupe A (fix crash + rebuild note) — 20260227-1130

## Objectif
Corriger le crash au démarrage causé par `Cannot find native module 'ExponentAV'`.
Le module `expo-av` est dans `package.json` mais n'est pas compilé dans le build Android actuel.
**Double action** :
1. Sécuriser le code pour que l'app ne crash plus (import dynamique + try/catch)
2. Documenter le rebuild nécessaire

## Fichiers concernés
- `mobile/src/utils/timerBeep.ts`
- `mobile/src/components/RestTimer.tsx`

## Contexte technique

### Problème
`timerBeep.ts` et `RestTimer.tsx` font un `import { Audio } from 'expo-av'` **statique** (top-level).
Avec Expo 52 + New Architecture (Bridgeless mode), un import statique d'un module natif absent
provoque un crash immédiat à l'initialisation du bundle JS — avant même de render quoi que ce soit.

### Cause
Le build Android installé sur le device a été compilé **avant** l'ajout de `expo-av` à `package.json`.
Le module natif `ExponentAV` n'est donc pas enregistré dans l'APK actuel.

### Solution code (ce groupe)
Remplacer l'import statique par un import **dynamique + try/catch** dans `timerBeep.ts` :
```typescript
// AVANT (crash si module absent)
import { Audio } from 'expo-av'
export async function createBeepSound(): Promise<Audio.Sound> {
  const { sound } = await Audio.Sound.createAsync({ uri: getBeepDataUri() })
  return sound
}

// APRÈS (silently fail si module absent)
export async function createBeepSound(): Promise<{ playAsync: () => Promise<void>; unloadAsync: () => Promise<void> } | null> {
  try {
    const { Audio } = await import('expo-av')
    const { sound } = await Audio.Sound.createAsync({ uri: getBeepDataUri() })
    return sound
  } catch {
    return null
  }
}
```

`RestTimer.tsx` :
- Supprimer `import { Audio } from 'expo-av'` (ligne 3)
- Supprimer `import type { Audio }` si présent
- Changer le type de `soundRef` de `Audio.Sound | null` → utiliser le type de retour de `createBeepSound()`
  ```typescript
  type SoundHandle = { playAsync: () => Promise<void>; unloadAsync: () => Promise<void> }
  const soundRef = useRef<SoundHandle | null>(null)
  ```
- Adapter `finishTimer()` : `createBeepSound()` peut retourner `null`, la chaîne `.then(sound => { soundRef.current = sound; return sound.playAsync() })` doit vérifier que sound est non-null
- Adapter le cleanup `soundRef.current.unloadAsync()` avec vérification `if (soundRef.current)`

### Solution build (à faire par le développeur après ce fix)
**IMPORTANT — à noter dans le rapport** :
```bash
cd mobile
npm run android  # rebuild natif avec expo-av inclus
```
Cette commande compile un nouveau APK de développement qui inclut `ExponentAV`.
Sans ce rebuild, le son sera silencieux (pas de crash, mais pas de son).

### Contraintes
- `expo-av` version `~15.0.2` dans `package.json` → ne pas changer
- `timerBeep.ts` ne doit plus avoir d'import statique `expo-av`
- `RestTimer.tsx` ne doit plus importer `Audio` depuis `expo-av`
- La logique vibration (haptics) fonctionne déjà — ne pas y toucher
- Pattern : `if (soundRef.current)` avant tout accès à soundRef (déjà présent, vérifier)
- Pas de `any` TypeScript

## Étapes

### 1. timerBeep.ts
- Supprimer `import { Audio } from 'expo-av'`
- Changer le type de retour de `createBeepSound` de `Promise<Audio.Sound>` en `Promise<SoundHandle | null>` où `SoundHandle = { playAsync: () => Promise<void>; unloadAsync: () => Promise<void> }`
- Wrapper le corps de `createBeepSound` dans un try/catch — retourner `null` en cas d'erreur
- Utiliser l'import dynamique : `const { Audio } = await import('expo-av')`

### 2. RestTimer.tsx
- Supprimer la ligne `import { Audio } from 'expo-av'` (ligne 3)
- Ajouter un type local `SoundHandle` (ou importer depuis timerBeep.ts si exporté)
- Changer le type de `soundRef` : `useRef<SoundHandle | null>(null)`
- Dans `finishTimer()` : adapter le `.then(sound => { if (sound) { soundRef.current = sound; return sound.playAsync() } })`
- Vérifier que le cleanup `soundRef.current.unloadAsync()` est bien guardé par `if (soundRef.current)`

## Contraintes
- Ne pas casser : vibration (haptics.onDelete), fermeture automatique, animation, notification
- Respecter : pas de `any`, pas de `console.log` hors `__DEV__`, mutations DB dans `database.write()`
- Le son doit silencieusement échouer (warn dans `__DEV__` seulement) si expo-av n'est pas disponible

## Critères de validation
- `npx tsc --noEmit` → zéro erreur
- `npm test` → zéro fail nouveau (les 7 échecs préexistants `ExercisePickerModal` sont hors scope)
- L'app démarre sans crash `Cannot find native module 'ExponentAV'`
- Dans `__DEV__`, un warn s'affiche si le son échoue (pas de crash silencieux total)
- Après `npm run android` (rebuild natif), le son fonctionne à la fin du timer

## Dépendances
Aucune dépendance sur d'autres groupes.

## Note post-fix
Après avoir appliqué ce fix, rappeler au développeur :
```
⚠️ REBUILD REQUIS pour activer le son :
cd mobile && npm run android
```

## Statut
⏳ En attente
