<!-- v1.0 ‚Äî 2026-02-21 -->
# Rapport ‚Äî ai-ux ‚Äî Groupe B ‚Äî 20260221-1800

## Objectif
Corriger deux bugs li√©s √† l'affichage du provider IA et √† la gestion de l'erreur 429 dans
l'√©cran Assistant :

1. **Bug badge** : `PROVIDER_LABELS` ne contient que `'offline'` ‚Üí badge affiche toujours
   "üîå Offline" m√™me quand l'utilisateur a configur√© OpenAI/Gemini/Claude
2. **Bug fallback silencieux** : quand le provider cloud √©choue (429, timeout‚Ä¶) et bascule
   sur offline, l'utilisateur voit le r√©sultat sans savoir que son provider cloud n'a pas fonctionn√©
3. **Bonus** : ajouter un retry √ó1 avec 1s backoff dans `openaiProvider.ts` avant fallback
   (√©vite le fallback sur un 429 transitoire)

## Fichiers concern√©s
- `mobile/src/screens/AssistantScreen.tsx` (badge + notification fallback)
- `mobile/src/services/ai/aiService.ts` (signaler le fallback √† l'appelant)
- `mobile/src/services/ai/openaiProvider.ts` (retry √ó1 sur 429)
- `mobile/src/services/ai/types.ts` (lire pour comprendre GeneratedPlan)

## Contexte technique
**Situation actuelle :**
- `AssistantScreen.tsx` ligne ~149 :
  ```ts
  const PROVIDER_LABELS: Record<string, string> = {
    offline: 'Offline',
    // openai, gemini, claude manquants !
  }
  ```
  ‚Üí `PROVIDER_LABELS['openai'] ?? 'Offline'` retourne `'Offline'` ‚Üí bug badge

- `aiService.ts` ligne ~119-125 :
  ```ts
  try {
    return await provider.generate(form, context)
  } catch (error) {
    if (__DEV__) console.warn('[aiService] Provider cloud √©chou√©, fallback offline:', error)
    return await offlineEngine.generate(form, context)
  }
  ```
  ‚Üí Le fallback est silencieux pour le composant appelant

- `AssistantScreen.tsx` ligne ~259-272 (`triggerGenerate`) :
  ```ts
  const plan = await generatePlan(data, user)
  setGeneratedPlan(plan)
  ```
  ‚Üí Pas de moyen de savoir si le plan vient du cloud ou de l'offline

**Patterns :**
- Stack : React Native, TypeScript strict, pas de `any`
- Pas de `console.log`/`console.warn` sans `__DEV__`
- Couleurs via `colors.*` de `theme/index.ts`
- `withTimeout` de `providerUtils.ts` pour les timeouts (pas `AbortSignal.timeout()`)
- Composant `AlertDialog` ou `BottomSheet` pour les dialogs (pas `Alert.alert` si √©vitable)
- Pas de `Alert.alert` natif sauf cas d'erreur critique

## √âtapes

### 1. Lire les fichiers
- `mobile/src/screens/AssistantScreen.tsx` (d√©j√† analys√© ‚Äî voir contexte)
- `mobile/src/services/ai/types.ts` (pour comprendre GeneratedPlan)
- `mobile/src/services/ai/aiService.ts` (d√©j√† analys√©)
- `mobile/src/services/ai/openaiProvider.ts` (d√©j√† analys√©)
- `mobile/src/services/ai/providerUtils.ts` (pour comprendre `withTimeout`)

### 2. Fix badge dans `AssistantScreen.tsx`
Compl√©ter `PROVIDER_LABELS` :
```ts
const PROVIDER_LABELS: Record<string, string> = {
  offline: 'Offline',
  openai:  'OpenAI',
  gemini:  'Gemini',
  claude:  'Claude',
}
```

### 3. Modifier `aiService.ts` pour signaler le fallback
Option A (propre ‚Äî modifie le type de retour) :
- Dans `types.ts` ou directement dans `aiService.ts`, d√©finir :
  ```ts
  export interface GeneratePlanResult {
    plan: GeneratedPlan
    usedFallback: boolean
    fallbackReason?: string
  }
  ```
- Modifier `generatePlan` pour retourner `GeneratePlanResult`
- Mettre √† jour l'appelant dans `AssistantScreen.tsx`

Option B (minimal ‚Äî si modifier le type est trop invasif) :
- Passer un callback optionnel `onFallback?: (error: unknown) => void` √† `generatePlan`
- L'appeler depuis `aiService.ts` avant le fallback
- Dans `AssistantScreen.tsx`, utiliser ce callback pour afficher une info √† l'utilisateur

**Pr√©f√©rer Option A** si `GeneratedPlan` n'est pas utilis√© dans de nombreux endroits.
V√©rifier avec Grep combien d'endroits appellent `generatePlan` avant de choisir.

### 4. Notification UX dans `AssistantScreen.tsx`
Apr√®s `triggerGenerate`, si `usedFallback === true` :
- Ajouter un √©tat `fallbackNotice` (string | null)
- Afficher un texte discret sous le plan g√©n√©r√© (ex: "Plan g√©n√©r√© hors ligne ‚Äî OpenAI indisponible")
- PAS un Alert.alert (trop intrusif)
- Un simple `<Text>` en `colors.textSecondary` suffira

### 5. Retry √ó1 dans `openaiProvider.ts`
Si la r√©ponse est 429 :
```ts
if (response.status === 429) {
  clear()
  await new Promise(r => setTimeout(r, 1000))
  const retry = withTimeout(30000)
  try {
    response = await fetch(OPENAI_URL, { ..., signal: retry.signal })
  } finally {
    retry.clear()
  }
}
```
Appeler `clear()` dans le `finally` du premier appel avant le retry.

## Contraintes
- Pas de `any` TypeScript
- Pas de `console.log`/`console.warn` sans `__DEV__`
- Pas de couleurs hardcod√©es ‚Äî utiliser `colors.*`
- `withTimeout` de `providerUtils.ts` UNIQUEMENT (pas `AbortSignal.timeout()`)
- Ne pas modifier le comportement de l'offline engine
- Si Option A (modifier le type de retour) ‚Üí mettre √† jour TOUS les appelants de `generatePlan`
- Ne pas casser `AssistantPreviewSheet` (v√©rifie sa signature)

## Crit√®res de validation
- `npx tsc --noEmit` ‚Üí z√©ro erreur
- `npm test` ‚Üí z√©ro fail (v√©rifier `__tests__/aiService.test.ts`)
- Badge affiche correctement "OpenAI", "Gemini" ou "Claude" selon le provider configur√©
- En cas de fallback offline, l'utilisateur voit une info dans l'UI (pas seulement dans les logs)
- Le retry fonctionne : un 429 transitoire ne d√©clenche plus le fallback imm√©diatement

## D√©pendances
Aucune d√©pendance (groupe ind√©pendant)

## Statut
‚è≥ En attente
