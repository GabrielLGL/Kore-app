# Prompt analysÃ© â€” CI Test Speed â€” 2026-02-19

## Demande originale
> Annotations â€” 2 errors â€” Run Tests (20.x) : The job has exceeded the maximum execution time of 10m0s / The operation was canceled. â€” que faire pour baisser le temps encore

## Analyse technique

### Cause racine identifiÃ©e
Le workflow CI dÃ©passe les 10 minutes malgrÃ© le cache `node_modules` dÃ©jÃ  en place (commit `3cb5404`).

**Deux problÃ¨mes restants :**

| # | ProblÃ¨me | Impact estimÃ© |
|---|----------|---------------|
| 1 | Cache Jest transform **absent** â€” Babel re-transforme depuis zÃ©ro `react-native`, `expo`, `@nozbe/watermelondb`, `@react-navigation` Ã  chaque run | ~4-6 min |
| 2 | **Workers parallÃ¨les** pour seulement 6 fichiers de test â†’ overhead de spawn inutile | ~1-2 min |

### Fichiers concernÃ©s
- `mobile/jest.config.js` â€” ajouter `cacheDirectory` + `maxWorkers: 1`
- `.github/workflows/ci.yml` â€” ajouter step cache Jest + `--runInBand` + timeout 15min

### Gain attendu
- 1er run aprÃ¨s merge : ~8-10 min (cache Jest se remplit)
- Runs suivants : **~2-3 min** (transform dÃ©jÃ  en cache)

## Commandes gÃ©nÃ©rÃ©es

| Groupe | /do | Fichiers | ParallÃ¨le |
|--------|-----|----------|-----------|
| A | /do Optimiser CI tests â€” Jest cache + runInBand | `mobile/jest.config.js`, `.github/workflows/ci.yml` | seul (fichiers couplÃ©s â€” mÃªme path cache) |

> **Pourquoi un seul groupe ?** Le `cacheDirectory` dans `jest.config.js` doit correspondre exactement au `path:` dans `ci.yml`. Modifier les deux dans le mÃªme `/do` Ã©vite toute dÃ©synchronisation.

## DÃ©tail des changements

### mobile/jest.config.js
```js
// Ajouter aprÃ¨s preset: 'jest-expo',
cacheDirectory: '/tmp/jest-cache',
maxWorkers: 1,
```

### .github/workflows/ci.yml
```yaml
# 1. timeout 10 â†’ 15 (buffer 1er run)
timeout-minutes: 15

# 2. Nouveau step (aprÃ¨s cache node_modules)
- name: ðŸ’¾ Cache Jest transform
  uses: actions/cache@v4
  with:
    path: /tmp/jest-cache
    key: ${{ runner.os }}-jest-cache-${{ hashFiles('mobile/jest.config.js', 'mobile/babel.config.js') }}
    restore-keys: |
      ${{ runner.os }}-jest-cache-

# 3. Modifier run tests
run: npm test -- --watchAll=false --passWithNoTests --forceExit --runInBand
```

## Commit suggÃ©rÃ©
```
chore(ci): add Jest transform cache + runInBand to fix 10min timeout
```
