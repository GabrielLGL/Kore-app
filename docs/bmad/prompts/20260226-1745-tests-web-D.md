
## Résolution
Rapport do : docs/bmad/do/20260226-1210-test-web-page.md
s page principale — 20260226-1745

## Objectif
Écrire les tests automatisés pour `web/src/app/page.tsx`.
Focus sur le formulaire d'inscription (composant interactif le plus important de la page).

## Fichiers concernés
- `web/src/app/page.tsx` — source (NE PAS MODIFIER)
- `web/src/app/__tests__/page.test.tsx` — créer (nouveau)

## Contexte technique
- Vitest + @testing-library/react + @testing-library/user-event + jsdom (Groupe A)
- `page.tsx` est un composant `"use client"` avec :
  - useState (email, name, status, navVisible)
  - useEffect (listener scroll window)
  - handleSubmit → fetch POST /api/subscribe
- Composants importés : KoreLogo, BackgroundBlobs, ThemeToggle, ScrollReveal
- `fetch` doit être mocké (jsdom ne fait pas de vraies requêtes)

**Éléments testables :**
- Formulaire présent avec champs email et name
- Submit sans email → pas d'appel fetch
- Submit avec email valide → appel fetch, status "loading" puis "success"
- Réponse non-ok → status "error"
- Messages d'alerte role="alert"

## Étapes

### 1. Créer `web/src/app/__tests__/page.test.tsx`

```tsx
import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest'
import { render, screen, fireEvent, waitFor } from '@testing-library/react'
import userEvent from '@testing-library/user-event'
import Home from '../page'

// Mocker les composants visuels (pas besoin de les rendre vraiment)
vi.mock('@/components/KoreLogo', () => ({
  default: () => <svg data-testid="logo" />,
}))
vi.mock('@/components/BackgroundBlobs', () => ({
  default: () => <div data-testid="blobs" />,
}))
vi.mock('@/components/ThemeToggle', () => ({
  default: () => <button data-testid="theme-toggle" />,
}))
vi.mock('@/components/ScrollReveal', () => ({
  default: () => <div data-testid="scroll-reveal" />,
}))

// Mocker fetch global
const mockFetch = vi.fn()
global.fetch = mockFetch

describe('Home page', () => {
  beforeEach(() => {
    vi.clearAllMocks()
  })

  afterEach(() => {
    vi.restoreAllMocks()
  })

  it('affiche le formulaire d\'inscription', () => {
    render(<Home />)
    expect(screen.getByLabelText(/adresse email/i)).toBeInTheDocument()
    expect(screen.getByLabelText(/prenom/i)).toBeInTheDocument()
    expect(screen.getByRole('button', { name: /s'inscrire/i })).toBeInTheDocument()
  })

  it('n\'appelle pas fetch si email vide', async () => {
    render(<Home />)
    const submitBtn = screen.getByRole('button', { name: /s'inscrire/i })
    fireEvent.click(submitBtn)
    expect(mockFetch).not.toHaveBeenCalled()
  })

  it('affiche "Inscription..." pendant le chargement', async () => {
    // fetch qui ne résout jamais (simule loading)
    mockFetch.mockReturnValue(new Promise(() => {}))

    render(<Home />)
    const emailInput = screen.getByLabelText(/adresse email/i)
    await userEvent.type(emailInput, 'test@example.com')

    const form = screen.getByRole('form', { name: /formulaire d'inscription/i })
    fireEvent.submit(form)

    expect(await screen.findByText(/inscription\.\.\./i)).toBeInTheDocument()
  })

  it('affiche le message success après inscription réussie', async () => {
    mockFetch.mockResolvedValue({ ok: true })

    render(<Home />)
    const emailInput = screen.getByLabelText(/adresse email/i)
    await userEvent.type(emailInput, 'test@example.com')

    const form = screen.getByRole('form', { name: /formulaire d'inscription/i })
    fireEvent.submit(form)

    const alert = await screen.findByRole('alert')
    expect(alert).toHaveTextContent(/inscription reussie/i)
  })

  it('affiche le message d\'erreur si l\'API échoue', async () => {
    mockFetch.mockResolvedValue({ ok: false })

    render(<Home />)
    const emailInput = screen.getByLabelText(/adresse email/i)
    await userEvent.type(emailInput, 'test@example.com')

    const form = screen.getByRole('form', { name: /formulaire d'inscription/i })
    fireEvent.submit(form)

    const alert = await screen.findByRole('alert')
    expect(alert).toHaveTextContent(/erreur/i)
  })

  it('vide les champs après succès', async () => {
    mockFetch.mockResolvedValue({ ok: true })

    render(<Home />)
    const emailInput = screen.getByLabelText(/adresse email/i)
    const nameInput = screen.getByLabelText(/prenom/i)

    await userEvent.type(emailInput, 'test@example.com')
    await userEvent.type(nameInput, 'Gabriel')

    const form = screen.getByRole('form', { name: /formulaire d'inscription/i })
    fireEvent.submit(form)

    await waitFor(() => {
      expect((emailInput as HTMLInputElement).value).toBe('')
      expect((nameInput as HTMLInputElement).value).toBe('')
    })
  })

  it('appelle fetch avec email et name corrects', async () => {
    mockFetch.mockResolvedValue({ ok: true })

    render(<Home />)
    await userEvent.type(screen.getByLabelText(/adresse email/i), 'test@example.com')
    await userEvent.type(screen.getByLabelText(/prenom/i), 'Gabriel')

    const form = screen.getByRole('form', { name: /formulaire d'inscription/i })
    fireEvent.submit(form)

    await waitFor(() => {
      expect(mockFetch).toHaveBeenCalledWith('/api/subscribe', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: 'test@example.com', name: 'Gabriel' }),
      })
    })
  })
})
```

### 2. Note sur le form aria-label
Dans `page.tsx`, le formulaire a `aria-label="Formulaire d'inscription"`.
`getByRole('form', { name: /formulaire d'inscription/i })` doit fonctionner.

## Contraintes
- Ne pas modifier `page.tsx`
- Mocker tous les composants importés (KoreLogo, BackgroundBlobs, ThemeToggle, ScrollReveal)
- Mocker `global.fetch` — ne jamais appeler l'API réelle
- Les tests doivent passer sans navigateur réel (jsdom uniquement)

## Critères de validation
- `npm test` (depuis `web/`) → 6 tests page passent
- Total tous groupes : ~16 tests passent

## Dépendances
Ce groupe dépend de : **Groupe A** (Vitest configuré) + idéalement **Groupe B** lancé avant (pour valider le setup fonctionne)

## Statut
✅ Résolu — 20260226-1210

## Résolution
Rapport do : docs/bmad/do/20260226-1210-test-web-page.md

