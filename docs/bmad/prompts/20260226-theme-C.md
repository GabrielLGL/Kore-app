<!-- v1.0 â€” 2026-02-26 -->
# Rapport â€” Settings Toggle + Navigation â€” Groupe C â€” 20260226

## Objectif
1. Connecter `ThemeProvider` dans `navigation/index.tsx` + charger la prÃ©fÃ©rence sauvegardÃ©e
2. Ajouter le toggle dark/light dans `SettingsScreen.tsx`

## Fichiers concernÃ©s
1. `mobile/src/navigation/index.tsx`
2. `mobile/src/screens/SettingsScreen.tsx`

---

## PRÃ‰REQUIS
Le Groupe B doit Ãªtre terminÃ© :
- `mobile/src/contexts/ThemeContext.tsx` existe
- `mobile/src/model/schema.ts` est en v23 avec `theme_mode`
- `mobile/src/model/models/User.ts` a `themeMode`

---

## 1. navigation/index.tsx

### Import Ã  ajouter
```ts
import { ThemeProvider, useTheme } from '../contexts/ThemeContext'
import type { ThemeMode } from '../theme'
```

### Nouveau composant interne `AppWithTheme`

Extraire le contenu de `AppNavigator` dans un composant interne qui peut consommer le ThemeContext :

```tsx
function AppContent() {
  const { colors, mode } = useTheme()
  const navigationRef = useNavigationContainerRef<RootStackParamList>()
  const [initialRoute, setInitialRoute] = useState<keyof RootStackParamList | null>(null)

  // ThÃ¨me Navigation dynamique basÃ© sur le mode actif
  const navTheme = {
    ...DarkTheme,
    dark: mode === 'dark',
    colors: {
      ...DarkTheme.colors,
      background: colors.background,
      card: colors.card,
      text: colors.text,
      border: colors.cardSecondary,
      primary: colors.primary,
    },
  }

  useEffect(() => {
    database.get<User>('users').query().fetch().then(users => {
      const user = users[0]
      setInitialRoute(!user || !user.onboardingCompleted ? 'Onboarding' : 'Home')
    })
  }, [])

  if (initialRoute === null) return null

  return (
    <NavigationContainer ref={navigationRef} theme={navTheme}>
      <GlobalBackHandler navigationRef={navigationRef} />
      <Stack.Navigator
        initialRouteName={initialRoute}
        screenOptions={{
          headerStyle: { backgroundColor: colors.background },
          headerTintColor: colors.text,
          headerShadowVisible: false,
          contentStyle: { backgroundColor: colors.background },
          statusBarStyle: mode === 'dark' ? 'light' : 'dark',
          statusBarBackgroundColor: colors.background,
        }}
      >
        {/* ... toutes les Stack.Screen inchangÃ©es ... */}
      </Stack.Navigator>
    </NavigationContainer>
  )
}
```

### Nouveau `AppNavigator` â€” charge la prÃ©fÃ©rence et fournit le Provider

```tsx
export default function AppNavigator() {
  const [initialMode, setInitialMode] = useState<ThemeMode>('dark')
  const [ready, setReady] = useState(false)

  // Charger la prÃ©fÃ©rence au dÃ©marrage
  useEffect(() => {
    database.get<User>('users').query().fetch().then(users => {
      const savedMode = users[0]?.themeMode
      if (savedMode === 'light' || savedMode === 'dark') {
        setInitialMode(savedMode)
      }
      setReady(true)
    })
  }, [])

  if (!ready) return null

  return (
    <ErrorBoundary>
      <PortalProvider>
        <ThemeProvider initialMode={initialMode}>
          <AppContent />
        </ThemeProvider>
      </PortalProvider>
    </ErrorBoundary>
  )
}
```

---

## 2. SettingsScreen.tsx

### Imports Ã  ajouter
```ts
import { useTheme } from '../contexts/ThemeContext'
```

### Dans `SettingsContent`

Ajouter au dÃ©but du composant :
```tsx
const { mode, toggleTheme, isDark } = useTheme()
```

### Supprimer l'import statique `colors` et utiliser `useTheme`
```ts
// AVANT :
import { colors, spacing, borderRadius, fontSize } from '../theme'

// APRÃˆS :
import { spacing, borderRadius, fontSize } from '../theme'
import { useTheme } from '../contexts/ThemeContext'
```

Dans le composant :
```tsx
const { colors, mode, isDark, toggleTheme } = useTheme()
```

DÃ©placer les styles dans la fonction composant (aprÃ¨s le hook useTheme) :
```tsx
const styles = StyleSheet.create({
  container: { flex: 1, backgroundColor: colors.background },
  // ... tous les styles avec colors dynamiques
})
```

### Section Apparence â€” Ã  ajouter aprÃ¨s "Section Mon profil"

```tsx
{/* Section Apparence */}
<View style={styles.section}>
  <Text style={styles.sectionTitle}>ðŸŽ¨ Apparence</Text>
  <View style={styles.settingRow}>
    <View style={styles.settingInfo}>
      <Text style={styles.settingLabel}>Mode {isDark ? 'sombre' : 'clair'}</Text>
      <Text style={styles.settingDescription}>
        {isDark ? 'Neumorphisme dark â€” fond #21242b' : 'Neumorphisme light â€” fond #e8ecef'}
      </Text>
    </View>
    <Switch
      value={isDark}
      onValueChange={async () => {
        haptics.onPress()
        await toggleTheme()
      }}
      trackColor={{ false: colors.cardSecondary, true: colors.primary }}
      thumbColor={colors.text}
    />
  </View>
</View>
```

---

## Contraintes
- `AppContent` doit accÃ©der Ã  `useTheme()` â†’ elle doit Ãªtre ENFANT de `ThemeProvider`
- `AppNavigator` ne peut PAS utiliser `useTheme()` (il fournit le Provider)
- statusBarStyle doit basculer : `'light'` en dark mode, `'dark'` en light mode
- Les styles dans SettingsContent doivent Ãªtre crÃ©Ã©s DANS le composant (aprÃ¨s les hooks)
  car ils dÃ©pendent de `colors` dynamiques

## CritÃ¨res de validation
- `npx tsc --noEmit` â†’ zÃ©ro erreur
- Le toggle dans Settings change l'apparence IMMÃ‰DIATEMENT (pas besoin de reboot)
- Le mode est persistÃ© : si on ferme/rouvre l'app, le mode est conservÃ©
- En light mode : le header change de couleur, le fond de l'app change

## DÃ©pendances
Groupe B doit Ãªtre complÃ©tÃ© avant ce groupe.

## Statut
âœ… RÃ©solu â€” 20260226-1500

## RÃ©solution
Rapport do : docs/bmad/do/20260226-1500-feat-theme-navigation-settings.md
