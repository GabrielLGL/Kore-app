<!-- v1.0 — 2026-02-23 -->
# Rapport — Coverage Tests Vague 2 — Groupe C — 20260223-2200

## Objectif
Augmenter la couverture des services et utilitaires avec un coverage insuffisant. Compléter la couche service pour un score global solide.

## Fichiers concernés
1. `mobile/src/services/ai/openaiProvider.ts` — 50% stmts (retry 429 non testé)
2. `mobile/src/services/secureKeyStore.ts` — 63% stmts
3. `mobile/src/services/ai/offlineEngine.ts` — 78% stmts
4. `mobile/src/services/ai/programGenerator/splitStrategy.ts` — 73% stmts

Tests existants à enrichir :
- `mobile/src/services/ai/__tests__/providers.test.ts` (couvre partiellement openaiProvider)
- `mobile/src/services/__tests__/secureKeyStore.test.ts`
- `mobile/src/services/ai/__tests__/offlineEngine.test.ts`
- `mobile/src/services/ai/programGenerator/__tests__/splitStrategy.test.ts`

## Contexte technique
- **Stack** : React Native (Expo 52) + TypeScript
- **Pattern de test** : Jest
- **Mocks** : `global.fetch` est mocké avec `jest.fn()` pour les providers AI
- **secureKeyStore** : Utilise `expo-secure-store` (doit être mocké)
- **offlineEngine** : Moteur de génération de programme offline — logique pure, pas d'API
- **splitStrategy** : Logique de sélection du type de split (PPL, Upper/Lower, Full Body, etc.)

## Étapes

### 1. openaiProvider.ts (50% → cible 90%+)
Lignes non couvertes : 32-51 (retry 429), 69-93 (testOpenAIConnection)
- **Tester le retry automatique sur HTTP 429** :
  - Mock fetch qui retourne 429 au 1er appel puis 200 au 2e
  - Vérifier que fetch est appelé 2 fois
  - Vérifier le délai de 1 seconde (utiliser `jest.useFakeTimers`)
- **Tester `testOpenAIConnection()`** :
  - Succès : mock fetch retourne 200 avec un message valide
  - Échec : mock fetch retourne 401 → vérifier que l'erreur est thrown
- **Tester les erreurs après retry** :
  - Mock fetch qui retourne 429 puis encore une erreur → vérifier l'erreur finale
- Créer le fichier `mobile/src/services/ai/__tests__/openaiProvider.test.ts` OU enrichir `providers.test.ts`

### 2. secureKeyStore.ts (63% → cible 85%+)
Lignes non couvertes : 23-24, 75-94
- Tester les cas d'erreur de `expo-secure-store` :
  - `getItemAsync` qui throw → retourne null/undefined
  - `setItemAsync` qui throw → gère l'erreur gracieusement
- Tester la suppression d'une clé
- Tester le cas où la clé n'existe pas

### 3. offlineEngine.ts (78% → cible 90%+)
Lignes non couvertes : 187-188, 203, 216, 250, 254-255, 311-342, 427-429, 459-461
- Tester les branches conditionnelles non couvertes :
  - Cas avec peu d'exercices disponibles
  - Cas avec profil débutant vs avancé
  - Cas edge : daysPerWeek = 2, daysPerWeek = 6
- Tester la gestion d'erreur (exercices manquants dans la DB)

### 4. splitStrategy.ts (73% → cible 90%+)
Lignes non couvertes : 25, 58-59, 69-79
- Tester les cas edge du `determineSplit()` :
  - 2 jours/semaine → Full Body
  - 6 jours/semaine → PPL
  - Niveaux intermédiaire et avancé
- Tester `buildWeeklySchedule()` pour tous les types de split
- Vérifier les muscles assignés à chaque jour

### 5. Vérifier
```bash
cd mobile && npx jest --coverage src/services/ai/__tests__/providers.test.ts src/services/__tests__/secureKeyStore.test.ts src/services/ai/__tests__/offlineEngine.test.ts src/services/ai/programGenerator/__tests__/splitStrategy.test.ts
```

## Contraintes
- Ne pas casser les 935 tests existants
- Ne pas modifier les fichiers source — uniquement les fichiers de test
- Pour les providers AI : mocker `global.fetch`, ne JAMAIS appeler de vraie API
- Pour secureKeyStore : mocker `expo-secure-store`
- Respecter les patterns de mock existants dans chaque fichier de test

## Critères de validation
- `npx tsc --noEmit` → zéro erreur
- `npm test` → zéro fail (935+ tests passent)
- openaiProvider ≥ 90% stmts
- secureKeyStore ≥ 85% stmts
- offlineEngine ≥ 88% stmts
- splitStrategy ≥ 90% stmts

## Dépendances
Aucune dépendance — ce groupe est indépendant des groupes A et B.

## Statut
✅ Résolu — 20260224-0030

## Résolution
Rapport do : docs/bmad/do/20260224-0030-test-coverage-services-v2C.md
