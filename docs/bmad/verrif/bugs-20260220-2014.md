# Bugs silencieux ‚Äî 20260220-2014

## R√©sum√© : üî¥ 0 critiques / üü° 4 warnings

Scan complet de `mobile/src/` (130+ fichiers `.ts`/`.tsx`).

---

### Critiques

_Aucun bug critique d√©tect√©._

---

### Warnings

| Fichier | Ligne | Type | Description |
|---------|-------|------|-------------|
| `screens/HomeScreen.tsx` | 289 | Async sans error handling | `onConfirm: async () => { await deleteProgram() }` ‚Äî si `deleteProgram` throw, l'erreur est silencieuse. Pas de feedback utilisateur. |
| `screens/HomeScreen.tsx` | 318 | Async sans error handling | `onConfirm: async () => { await deleteSession() }` ‚Äî m√™me pattern, m√™me risque. |
| `services/ai/geminiProvider.ts` | 39 | `return` sans `await` sur async | `return throwGeminiError(response)` ‚Äî fonctionnellement correct (la rejection se propage), mais incoh√©rent : sans `await`, la fonction `generate()` n'appara√Æt pas dans la stack trace en cas d'erreur. |
| `services/ai/geminiProvider.ts` | 77 | `return` sans `await` sur async | M√™me pattern dans `testGeminiConnection()`. |

---

### Faux positifs confirm√©s

| Fichier | Ligne | Raison du rejet |
|---------|-------|-----------------|
| `model/utils/databaseHelpers.ts` | 309-311 | `histories.sort()[0]` ‚Äî safe : `sets.length === 0` return early (L297) garantit `histories.length >= 1`. |
| `screens/WorkoutScreen.tsx` | 142 | `setConfirmEndVisible(false)` ‚Äî safe : la ligne pr√©c√©dente est `await completeWorkoutHistory(...).catch(...)`, les state changes sont bien APR√àS le write. |

---

### WatermelonDB mutations ‚úÖ

Toutes les mutations (`create`, `update`, `destroyPermanently`, `batch`) sont correctement wrapp√©es dans `database.write()`. Aucun bug d√©tect√© sur 36 occurrences dans 13 fichiers.

### Memory leaks ‚úÖ

- Tous les `setTimeout`/`setInterval` ont leur cleanup (5 locations v√©rifi√©es).
- Tous les listeners keyboard/BackHandler ont leur `removeEventListener`.
- Pattern `withObservables` HOC utilis√© partout ‚Äî pas de `.subscribe()` manuel non nettoy√©.

### Null safety ‚úÖ

- Acc√®s par index `[0]` v√©rifi√©s : tous gard√©s par des length checks ou optional chaining.
- Pas de division par z√©ro possible.

---

## Analyse des warnings HomeScreen

Les deux callbacks de suppression utilisent le pattern :
```tsx
onConfirm: async () => { await deleteProgram() }
// ou
onConfirm: async () => { await deleteSession() }
```

Si `deleteProgram()`/`deleteSession()` throw (ex: erreur DB), l'exception est une unhandled Promise rejection. L'utilisateur ne voit aucun message d'erreur. L'action semble avoir r√©ussi alors qu'elle a √©chou√©.

**Fix recommand√© :** Ajouter un try/catch avec feedback utilisateur.

## Analyse des warnings geminiProvider

```typescript
// L39 ‚Äî generate()
if (!response.ok) {
  return throwGeminiError(response)  // devrait √™tre: return await throwGeminiError(response)
}

// L77 ‚Äî testGeminiConnection()
if (!response.ok) {
  return throwGeminiError(response)  // idem
}
```

`throwGeminiError` est `async` (elle await `response.json()`). Retourner sans `await` est fonctionnellement √©quivalent ici (pas de try/catch autour), mais :
1. La fonction courante n'appara√Æt pas dans la stack trace d'erreur
2. Incoh√©rence avec les bonnes pratiques TypeScript (`@typescript-eslint/return-await`)

**Fix recommand√© :** `return await throwGeminiError(response)` aux deux endroits.

---

## Parall√©lisation des corrections

| # | Probl√®me | Fichiers | Effort | Groupe |
|---|----------|----------|--------|--------|
| 1 | HomeScreen delete sans error handling | `HomeScreen.tsx` | ~15 min | A |
| 2 | geminiProvider return sans await | `geminiProvider.ts` | ~5 min | B |

Groupes : A et B = fichiers diff√©rents ‚Üí **parall√©lisables**.

- Claude Code 1 : Groupe A ‚Äî HomeScreen (2 callbacks)
- Claude Code 2 : Groupe B ‚Äî geminiProvider (2 lignes)

---

## Prochaines √©tapes

```
‚ö° Prochaines √©tapes

‚Üí /do [bugs-20260220-2014 ‚Äî warning HomeScreen: deleteProgram/deleteSession sans error handling (L289, L318)]   ‚Üê groupe A
‚Üí /do [bugs-20260220-2014 ‚Äî warning geminiProvider: return throwGeminiError sans await (L39, L77)]             ‚Üê groupe B (parall√®le)
‚Üí /verrif-db                 ‚Üê continuer les v√©rifications
```
